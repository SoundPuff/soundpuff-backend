name: Deploy Soundpuff

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout backend
      uses: actions/checkout@v4

    - uses: actions/setup-node@v4
      with:
        node-version: 20

    # Optional: sanity check backend deps (never deploy a broken lockfile)
    - name: Backend sanity check
      run: |
        pip install uv
        uv pip install -r app/requirements.txt || true

    - name: SSH deploy
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        script: |
          set -e

          export PATH="/home/deploy/.local/bin:$PATH"

          # Install uv if missing
          if ! command -v uv &> /dev/null; then
            curl -LsSf https://astral.sh/uv/install.sh | sh
            export PATH="/home/deploy/.local/bin:$PATH"
          fi

          echo ">>> Preparing directory"
          mkdir -p /var/www/soundpuff
          cd /var/www/soundpuff

          ######## BACKEND ########
          if [ ! -d "backend/.git" ]; then
            echo ">>> Cloning backend"
            git clone https://github.com/SoundPuff/soundpuff-backend.git backend
          else
            echo ">>> Updating backend"
            cd backend
            git fetch --all
            git reset --hard origin/main
            cd ..
          fi

          echo ">>> Sync backend deps"
          cd backend
          uv sync
          cd ..

          ######## FRONTEND ########
          if [ ! -d "frontend/.git" ]; then
            echo ">>> Cloning frontend"
            git clone https://github.com/SoundPuff/SoundPuff-gui-v2.git frontend
          else
            echo ">>> Updating frontend"
            cd frontend
            git fetch --all
            git reset --hard origin/main
            cd ..
          fi

          echo ">>> Building frontend"
          cd frontend
          npm install
          npx vite build
          cd ..

          ######## SERVICE RESTART ########
          echo ">>> Restarting soundpuff.service"
          sudo systemctl daemon-reload
          sudo systemctl restart soundpuff

          echo ">>> Checking service status"
          sleep 2
          sudo systemctl --no-pager --full status soundpuff || exit 1
